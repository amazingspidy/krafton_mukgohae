<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">

    <!-- Optional JavaScript -->
    <!-- jQuery and Bootstrap Bundle (includes Popper) -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"> </script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
            integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
            crossorigin="anonymous"></script>
    <title>먹고해 | 메인페이지</title>
    <style>
        .rightbutton {
            width: 390px;
            
            text-align: right;
        }
        .centerbutton {
            width: 390px;
            
            text-align: center;
        }
        .lefttextbox {
            text-align: left;
        }
    </style>
    <script>

        let orderMode;  //이미 주문을 완료하거나 글쓰기를 한사람한테는 True
        
        function go_signup() {
            window.location.href = '/signup'
        }
        function go_login() {
            window.location.href = '/login'
        }
        // 이전 JavaScript 함수에서 사용자 인증 확인을 요청하는 함수를 수정
        function hello() {
            $.ajax({
                type: "GET",
                url: "/api/secure",
                data: {},
                success: function (response) {
                    if (response['result'] == 'success') {
                        // 로그인한 사용자면 닉네임을 보여주는 알람을 띄움!
                        let nickname = response['nickname']
                        alert(`반갑습니다 ${nickname}님!!`)
                    } else {
                        alert(response['message'])
                        window.location.href = '/login'
                    }
                }
            })
        }
        
        function logout() {
            $.ajax({
                type: "GET",
                url: "/logout",
                data: {},
                success: function (response) {
                    // 로그아웃이 성공한 경우 페이지 새로고침
                    window.location.reload();
                }
            })
        }


        $(document).ready(function () {
            // 맨 처음 접속시에는 orderMode 가 False입니다.
            orderMode = false;
            show_orders();
            hello()
        });


        function changeParti() {
            if (orderMode == false) {
                alert('참여완료!')
                $('#parti-button').empty()
                $('#parti-button').append('<button id="show-info" onclick="go_order_detail()"> 게시판보기</button>')
                orderMode = true
            }
            
        }
        function go_order_detail() {
            alert('게시판으로갑니다')

        }

        function go_write() {
            window.location.href = '/write'
        }

        function show_orders() {
            console.log('hey!!!')
            $.ajax({
                type: "GET",
                url: "/list",
                data: {},
                success: function (response) {
                    let orders = response["orders"];
                    for (let i = 0; i < orders.length; i++) {
                        make_orders(orders[i]["order_date"],orders[i]["order_time"],
                        orders[i]["food_category"], orders[i]["with_who"], orders[i]["food_shop"], 
                        orders[i]["food_name"], orders[i]["ppl_num_aim"], orders[i]["ppl_num_max"]);
                    }
                }
            })
        }

        function make_orders(order_date, order_time, food_category, with_who, food_shop, food_name,ppl_num_aim,ppl_num_max ){
            let temp_html = `
            <div class="card">
            <div class="card-header">
              함께먹나요? ${with_who}  ${food_category}먹어요
            </div>
            <div class="card-body">
              <h5 class="card-title">날짜 & 시간</h5>
              <p class="card-text">${order_date}, ${order_time}</p>
              <p class="card-text">최대 ${ppl_num_max} 명중 ${ppl_num_aim}명 참여!</p>
              <div id = "parti-button" onclick="changeParti()"> <button> 참여하기</button> </div> 
            </div>
        </div>`;
        $("#orders-list").append(temp_html);

            
        }

        // {% for order in orders %}
        // <div class="card">
        //     <div class="card-header">
        //       {{ order.withwho }} 먹어요
        //     </div>
        //     <div class="card-body">
        //       <h5 class="card-title">날짜 & 시간</h5>
        //       <p class="card-text">{{ order.restaurant }}/{{ order.menu }}/주문자명</p>
        //       <p class="card-text">최대 n명중 m명 참여! (m/n)</p>
        //       <div id = "parti-button" onclick="changeParti()"> <button> 참여하기</button> </div> 
        //     </div>
        // </div>
        // {% endfor %} 
    </script>
</head>

<body>
    <div class = "rightbutton">
        <!-- 로그인 상태에 따라 로그아웃 또는 로그인 버튼을 표시 -->
        {% if 'email' in session %}
        <button onclick="logout()">로그아웃</button>
        {% else %}
        <button onclick="go_login()">로그인</button>
        {% endif %}
        <button id="write-order" onclick="go_write()">글쓰기</button>
        <div style = "width:180px; border: 1px dotted;"> <div class = "lefttextbox"> 먹고싶은걸 고르셨다면?</div></div>
        <hr width = "100%" color = "black">
        
            <div class = "centerbutton">
                <button> 치킨 </button><button> 햄버거 </button><button> 족발/보쌈 </button><button> 중식 </button> <br>
                <button> 피자 </button><button> 분식 </button><button> 일식 </button><button> 디저트 </button><button> 기타 </button>
            </div>
            <hr width = "100%" color = "black">
        <div style = "width:180px; border: 1px dotted;"> <div class = "lefttextbox"> 뭐 먹을지 모르겠을때!</div></div>
        <div id = "orders-list"> </div>
        
          
    </div>
    
    
    
    
</body>


</html>